<!DOCTYPE html>
<html lang="it">
<head>
  <meta name="robots" content="noindex">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Social Dashboard – Final v6.3 (Icons Fix)</title>
  <link rel="icon" href="faviconAI.ico" />

  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
  />

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-pE6N1H8uZ6rS2E6EeD+WmY8/tPzTiPjzr6yPLGwFqvYykv2kK1oaXV1z+g8fVG8rBpyxOaNvGqZcIYITu5r3Q=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary-blue: #0047bb;
      --primary-hover: #00368f;
      --accent-yellow: #eedc00;
      --bg-gray: #f4f5f7;
      --surface-white: #ffffff;
      --text-dark: #172B4D;
      --text-medium: #5E6C84;
      --border-color: #dfe1e6;
      --success-green: #36b37e;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
      --radius: 8px;
      --font-family-base: 'Inter', sans-serif;
    }

    body {
      font-family: var(--font-family-base);
      background-color: var(--bg-gray);
      color: var(--text-dark);
      line-height: 1.5;
      margin: 0;
      padding: 0;
    }

    /* --- LAYOUT GENERALE --- */
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .main-header {
      background-color: var(--surface-white);
      border-bottom: 4px solid var(--accent-yellow);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .main-header h1 { margin: 0; color: var(--primary-blue); font-size: 1.6rem; }

    /* Tabs */
    .tabs-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 24px;
      background: #e9ecef;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      color: var(--text-medium);
      transition: 0.2s;
    }
    .tab-btn.active {
      background: var(--primary-blue);
      color: #fff;
    }

    /* --- GRIGLIA --- */
    .layout-grid {
      display: grid;
      grid-template-columns: 1fr; 
      gap: 30px;
      align-items: start;
    }
    @media (min-width: 1024px) {
      .layout-grid {
        grid-template-columns: 55% 43%;
      }
    }

    /* --- COLUMN STYLES --- */
    .editor-container {
      background: var(--surface-white);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-color);
    }

    .preview-container {
      position: sticky;
      top: 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Card Anteprima */
    .card-anteprima-finale {
      background-color: #ffffff !important;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .header-anteprima {
      background-color: #f1f3f5;
      padding: 12px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .titolo-anteprima {
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .corpo-anteprima {
      padding: 24px;
      background-color: #ffffff !important;
      color: #333333 !important;
      font-size: 1rem;
      line-height: 1.6;
      font-weight: 400;
      white-space: pre-wrap;
      text-align: left;
      min-height: 100px;
    }
    .btn-copia-header {
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary-blue);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .btn-copia-header:hover {
      background-color: var(--primary-blue);
      color: #fff;
      border-color: var(--primary-blue);
    }

    /* --- INPUTS --- */
    .field-group { margin-bottom: 24px; }
    
    /* Struttura Header allineata */
    .label-row { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 8px; 
      min-height: 32px;
    }
    
    .label-text { 
      font-weight: 600; 
      font-size: 0.95rem; 
      color: var(--primary-blue); 
    }

    /* Contenitore destra che raggruppa Toolbar e Contatore */
    .right-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .toolbar {
      display: flex;
      gap: 4px;
      margin: 0;
    }

    textarea, input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: var(--font-family-base);
      font-size: 1rem;
      resize: vertical;
    }
    textarea:focus, input[type="text"]:focus { outline: 2px solid var(--primary-blue); border-color: transparent; }

    /* Stile Bottoni Strumenti Aggiornato */
    .tool-btn {
      background: #ffffff;
      border: 1px solid #dcdcdc;
      color: #5E6C84;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      min-width: 36px; /* Larghezza minima per evitare icone schiacciate */
      height: 32px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px; /* Spazio tra icona e testo se presente */
    }
    .tool-btn:hover { background: #e9ecef; color: var(--primary-blue); border-color: var(--primary-blue); }
    
    /* Stile per il feedback successo */
    .tool-btn.success-feedback {
        background-color: #e6fffa;
        color: #00875a;
        border-color: #00875a;
    }

    /* --- AI BOX --- */
    .ai-box {
      background: #f8faff;
      border: 1px solid #d0d7de;
      border-left: 4px solid var(--accent-yellow);
      padding: 15px;
      margin-bottom: 25px;
      border-radius: 6px;
    }
    .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .btn-generate {
      width: 100%;
      background: var(--primary-blue);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn-generate:hover { background: var(--primary-hover); }

    /* Button Prompt */
    .btn-prompt-modal {
      background-color: #fff;
      border: 1px solid var(--primary-blue);
      color: var(--primary-blue);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-prompt-modal:hover { background-color: #eef4ff; }

    /* --- ACTIONS & IMPORT --- */
    .actions-row {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .action-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      color: white;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-save { background: var(--primary-blue); }
    .btn-clear { background: #dc3545; }
    .btn-utility { background: #6c757d; }

    .import-bar {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* --- MODAL STYLES --- */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
    
    .modal-content {
      background: #fff;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f9fafb;
    }
    .modal-header h2 { margin: 0; color: var(--primary-blue); font-size: 1.4rem; }
    .close-modal {
      background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;
    }
    
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-news-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .news-input-block {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .news-input-block h3 { margin-top: 0; color: var(--text-dark); font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
    
    .prompt-output-area {
        background: #1e293b;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        white-space: pre-wrap;
        margin-top: 20px;
        display: none;
        position: relative;
    }

    /* Utility */
    .hidden { display: none; }
    .counter { font-size: 0.8rem; color: #777; }
    .loader { display: none; text-align: center; margin-top: 10px; }
    
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

  </style>
</head>
<body>

  <div class="app-container">
    <div class="main-header">
      <div>
        <h1>Social Network Dashboard</h1>
        <p style="margin:0; color:#666;">Versione v6.3</p>
      </div>
    </div>

    <div class="import-bar">
      <label for="fileInput" class="action-btn" style="background:#28a745; margin:0;">
        <i class="fas fa-file-import"></i> Importa Excel/CSV
      </label>
      <input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none;" />
      <button id="pasteCsvButton" class="action-btn" style="background:#17a2b8; margin:0;">
        <i class="fas fa-paste"></i> Incolla CSV da Appunti
      </button>
    </div>

    <div class="tabs-container">
      <div class="tab-btn active" data-index="0">News 1</div>
      <div class="tab-btn" data-index="1">News 2</div>
      <div class="tab-btn" data-index="2">News 3</div>
    </div>

    <div id="dynamicContent"></div>
  </div>

  <div class="modal-overlay" id="promptModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-magic"></i> Generatore Prompt Gemini</h2>
        <button class="close-modal" id="closePromptModal">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color:#666; margin-bottom:20px;">
          Inserisci i dettagli delle notizie. Se hai già scritto nell'editor, i campi verranno pre-compilati.
          Clicca "Genera Prompt", copia il risultato e incollalo su Gemini. Poi usa "Incolla CSV" nella dashboard.
        </p>
        
        <div class="modal-news-grid">
            <div class="news-input-block">
                <h3><i class="fas fa-newspaper"></i> News 1</h3>
                <label style="display:block; font-size:0.85rem; margin-bottom:4px;">Testo Notizia</label>
                <textarea id="modal-news-1" rows="4" placeholder="Testo notizia 1..."></textarea>
                <input type="text" id="modal-video-1" placeholder="File video (opzionale)" style="margin-top:8px;">
                <input type="text" id="modal-specs-1" placeholder="Note extra (opzionale)" style="margin-top:8px;">
            </div>
            <div class="news-input-block">
                <h3><i class="fas fa-newspaper"></i> News 2</h3>
                <label style="display:block; font-size:0.85rem; margin-bottom:4px;">Testo Notizia</label>
                <textarea id="modal-news-2" rows="4" placeholder="Testo notizia 2..."></textarea>
                <input type="text" id="modal-video-2" placeholder="File video (opzionale)" style="margin-top:8px;">
                <input type="text" id="modal-specs-2" placeholder="Note extra (opzionale)" style="margin-top:8px;">
            </div>
            <div class="news-input-block">
                <h3><i class="fas fa-newspaper"></i> News 3</h3>
                <label style="display:block; font-size:0.85rem; margin-bottom:4px;">Testo Notizia</label>
                <textarea id="modal-news-3" rows="4" placeholder="Testo notizia 3..."></textarea>
                <input type="text" id="modal-video-3" placeholder="File video (opzionale)" style="margin-top:8px;">
                <input type="text" id="modal-specs-3" placeholder="Note extra (opzionale)" style="margin-top:8px;">
            </div>
        </div>

        <button id="btnGeneratePrompt" class="action-btn" style="background:var(--primary-blue); width:100%; justify-content:center; padding:15px; font-size:1.1rem;">
            Genera Prompt Strutturato
        </button>

        <div id="promptOutputArea" class="prompt-output-area">
            <button id="btnCopyPrompt" class="btn-prompt-modal" style="position:absolute; top:10px; right:10px;">
                <i class="fas fa-copy"></i> Copia
            </button>
            <code id="promptCodeBlock"></code>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* --- CONFIGURAZIONE --- */
    let masterList = [];
    const API_URL = 'https://aipost.onrender.com/generate';
    const googleSheetURL = 'https://fabiusai.github.io/WhatsappCopy/maiuscole.csv';

    const tabsConfig = Array.from({ length: 3 }, () => ({
      limits: { wa: 82, ytTitle: 49, ytDesc: 280 },
      fields: ['wa', 'ytTitle', 'ytDesc', 'ytLink', 'tgLink']
    }));

    /* --- HTML GENERATOR --- */
    function generateTabHTML(index) {
      
      // Helper toolbar con icone aggiornate
      // Uso fa-solid per sicurezza e fa-rotate-left al posto di undo
      const getToolbar = (targetId, extraBtn = '') => `
        <div class="toolbar">
          <button class="tool-btn" data-action="lower" title="minuscolo">abc</button>
          <button class="tool-btn" data-action="title" title="Iniziali Maiuscole">Abc</button>
          <button class="tool-btn" data-action="upper" title="MAIUSCOLO">ABC</button>
          <button class="tool-btn" data-action="auto" title="Formatta Auto" style="color:#0047bb;"><i class="fa-solid fa-wand-magic-sparkles"></i> Auto</button>
          <button class="tool-btn" data-action="revert" title="Ripristina originale"><i class="fa-solid fa-rotate-left"></i></button>
          ${extraBtn}
        </div>`;

      // Bottone copia specifico per YT Title
      const copyTitleBtn = `<button class="tool-btn btn-copy-simple" data-target="ytTitle-${index}" title="Copia Titolo"><i class="fa-solid fa-copy"></i></button>`;

      return `
      <div class="tab-pane ${index === 0 ? '' : 'hidden'}" data-tab="${index}">
        
        <div class="layout-grid">
          
          <div class="editor-container">
            
            <div class="ai-box">
              <div class="ai-header">
                <h3 style="margin:0; color:#0047bb;"><i class="fas fa-robot"></i> Generatore AI</h3>
                <button class="btn-prompt-modal" id="openPromptBtn-${index}">
                    <i class="fas fa-magic"></i> Prompt Gemini
                </button>
              </div>
              <textarea id="ai-input-${index}" placeholder="Incolla qui il testo grezzo..." style="min-height:80px;"></textarea>
              <button class="btn-generate" data-idx="${index}">Genera Testi (API Interna)</button>
              <div class="loader" id="ai-loader-${index}"><i class="fas fa-spinner fa-spin"></i> Elaborazione...</div>
            </div>

            <div class="field-group">
              <div class="label-row">
                <span class="label-text">Testo WhatsApp</span>
                <div class="right-controls">
                    ${getToolbar()}
                    <span class="counter" id="count-wa-${index}">0/${tabsConfig[index].limits.wa}</span>
                </div>
              </div>
              <textarea id="wa-${index}" data-type="wa" rows="3"></textarea>
            </div>

            <div class="field-group">
              <div class="label-row">
                <span class="label-text">Titolo YouTube</span>
                <div class="right-controls">
                    ${getToolbar(`ytTitle-${index}`, copyTitleBtn)}
                    <span class="counter" id="count-ytTitle-${index}">0/${tabsConfig[index].limits.ytTitle}</span>
                </div>
              </div>
              <textarea id="ytTitle-${index}" data-type="ytTitle" rows="2"></textarea>
            </div>

            <div class="field-group">
              <div class="label-row">
                <span class="label-text">Descrizione Social</span>
                <div class="right-controls">
                    ${getToolbar()}
                    <span class="counter" id="count-ytDesc-${index}">0/${tabsConfig[index].limits.ytDesc}</span>
                </div>
              </div>
              <textarea id="ytDesc-${index}" data-type="ytDesc" rows="5"></textarea>
            </div>

            <div class="field-group">
              <div class="label-row"><span class="label-text">Link YouTube</span></div>
              <textarea id="ytLink-${index}" data-type="ytLink" rows="1"></textarea>
            </div>

            <div class="field-group">
              <div class="label-row">
                <span class="label-text">Link TG Poste</span>
                <div class="right-controls">
                  <button class="tool-btn btn-date" data-idx="${index}" data-day="today" title="Inserisci data di Oggi">
                    <i class="fa-solid fa-calendar-day"></i> Oggi
                  </button>
                  <button class="tool-btn btn-date" data-idx="${index}" data-day="yesterday" title="Inserisci data di Ieri">
                    <i class="fa-solid fa-clock-rotate-left"></i> Ieri
                  </button>
                </div>
              </div>
              <textarea id="tgLink-${index}" data-type="tgLink" rows="1"></textarea>
            </div>

            <div class="actions-row">
              <button class="action-btn btn-save" data-idx="${index}"><i class="fas fa-save"></i> Salva</button>
              <button class="action-btn btn-clear" data-idx="${index}"><i class="fas fa-trash"></i> Pulisci</button>
              <button class="action-btn btn-utility btn-copy-all"><i class="fas fa-copy"></i> Copia Tutto</button>
              <button class="action-btn btn-utility" style="background:#217346;" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Excel</button>
              <button class="action-btn btn-utility" style="background:#1d6f42;" onclick="exportCsv()"><i class="fas fa-file-csv"></i> CSV</button>
            </div>

          </div>

          <div class="preview-container">
            
            <div class="card-anteprima-finale">
              <div class="header-anteprima">
                <div class="titolo-anteprima"><i class="fab fa-whatsapp" style="color:#25D366; font-size:1.2em;"></i> Anteprima WhatsApp</div>
                <button class="btn-copia-header" data-copy-target="preview-wa-${index}">
                  <i class="fas fa-copy"></i> Copia
                </button>
              </div>
              <div class="corpo-anteprima" id="preview-wa-${index}"></div>
            </div>

            <div class="card-anteprima-finale">
              <div class="header-anteprima">
                <div class="titolo-anteprima"><i class="fas fa-share-nodes" style="color:#0047bb; font-size:1.2em;"></i> Anteprima Social</div>
                <button class="btn-copia-header" data-copy-target="preview-social-${index}">
                  <i class="fas fa-copy"></i> Copia
                </button>
              </div>
              <div class="corpo-anteprima" id="preview-social-${index}"></div>
            </div>

          </div>

        </div>
      </div>
      `;
    }

    /* --- INITIALIZATION --- */
    async function init() {
      masterList = await getMasterList();
      const container = document.getElementById('dynamicContent');
      container.innerHTML = [0, 1, 2].map(i => generateTabHTML(i)).join('');
      
      setupListeners();
      loadSavedData();
      updateAllPreviews();
      setupModalLogic();
    }

    function setupListeners() {
      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
          e.target.classList.add('active');
          document.querySelector(`.tab-pane[data-tab="${e.target.dataset.index}"]`).classList.remove('hidden');
        });
      });

      // Inputs
      document.querySelectorAll('textarea').forEach(el => {
        el.addEventListener('input', (e) => {
          updateCounts(e.target);
          updatePreview(e.target.closest('.tab-pane').dataset.tab);
        });
        el.addEventListener('focus', function() {
           if(!this.dataset.original) this.dataset.original = this.value;
        });
      });

      // Buttons Delegate
      document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('.tool-btn');
        if (!btn) return;
        
        if (btn.dataset.action) {
          const textarea = btn.closest('.field-group').querySelector('textarea');
          handleTextAction(textarea, btn.dataset.action, btn);
        }
        
        if (btn.classList.contains('btn-copy-simple')) {
           const targetId = btn.dataset.target;
           const textarea = document.getElementById(targetId);
           copyToClipboard(textarea.value, btn);
        }

        if (btn.classList.contains('btn-date')) {
           const idx = btn.dataset.idx;
           const target = document.getElementById(`tgLink-${idx}`);
           const date = new Date();
           if(btn.dataset.day === 'yesterday') date.setDate(date.getDate() - 1);
           target.value = generateTgLink(date);
           target.dispatchEvent(new Event('input'));
           
           // Feedback anche per il bottone data
           const originalHTML = btn.innerHTML;
           btn.classList.add('success-feedback');
           btn.innerHTML = '<i class="fas fa-check"></i>';
           setTimeout(() => {
              btn.innerHTML = originalHTML;
              btn.classList.remove('success-feedback');
           }, 1000);
        }
      });

      // AI Button Internal
      document.querySelectorAll('.btn-generate').forEach(btn => {
        btn.addEventListener('click', () => handleAI(btn.dataset.idx));
      });

      // Open Modal Buttons
      document.querySelectorAll('.btn-prompt-modal').forEach(btn => {
          btn.addEventListener('click', openPromptModal);
      });

      // Copy Preview
      document.querySelectorAll('.btn-copia-header').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.copyTarget;
          const idx = targetId.split('-')[2];
          
          if (targetId.includes('preview-wa')) {
             if(!document.getElementById(`ytLink-${idx}`).value.trim()) return alert("⚠️ Attenzione: Inserire il Link YouTube prima di copiare!");
          }
          if (targetId.includes('preview-social')) {
             if(!document.getElementById(`tgLink-${idx}`).value.trim()) return alert("⚠️ Attenzione: Inserire il Link TG Poste prima di copiare!");
          }

          const text = document.getElementById(targetId).innerText;
          copyToClipboard(text, btn);
        });
      });

      // Actions
      document.querySelectorAll('.btn-save').forEach(btn => btn.addEventListener('click', () => saveData(btn.dataset.idx, btn)));
      document.querySelectorAll('.btn-clear').forEach(btn => btn.addEventListener('click', () => clearData(btn.dataset.idx)));
      document.querySelector('.btn-copy-all').addEventListener('click', copyAllData);
      
      // Import Handlers
      document.getElementById('fileInput').addEventListener('change', handleFileInput);
      document.getElementById('pasteCsvButton').addEventListener('click', handlePasteCsv);
    }

    /* --- LOGICA MODALE PROMPT --- */
    function setupModalLogic() {
        const modal = document.getElementById('promptModal');
        const closeBtn = document.getElementById('closePromptModal');
        const generateBtn = document.getElementById('btnGeneratePrompt');
        const copyBtn = document.getElementById('btnCopyPrompt');

        closeBtn.addEventListener('click', () => {
            modal.classList.remove('open');
        });
        
        // Chiudi se clicchi fuori
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('open');
        });

        generateBtn.addEventListener('click', () => {
            let newsCount = 0;
            let newsContent = "";
            let columnHeaders = [];

            for (let i = 1; i <= 3; i++) {
                const text = document.getElementById(`modal-news-${i}`).value.trim();
                const video = document.getElementById(`modal-video-${i}`).value.trim();
                const specs = document.getElementById(`modal-specs-${i}`).value.trim();

                if (text) {
                    newsCount++;
                    columnHeaders.push(`"News ${newsCount}"`);
                    newsContent += `\n---\n**NEWS ${newsCount}**\n**Testo:**\n${text}\n`;
                    if (video) newsContent += `**Riferimento video:**\n${video}\n`;
                    if (specs) newsContent += `**Specifiche aggiuntive:**\n${specs}\n`;
                }
            }

            if (newsCount === 0) return alert("Inserisci almeno una notizia!");

            const finalPrompt = `Sei un assistente per la creazione di contenuti social. Il tuo compito è generare dei testi per i canali social partendo dalle informazioni fornite.

**INFORMAZIONI SULLE NOTIZIE:**
${newsContent}

**DIRETTIVE DI STILE E TONO:**
* **Tono di voce:** Chiaro e istituzionale, senza enfasi.
* **Stile:** Semplice ed informativo.
* **Brand:** Parla a nome dell'azienda "Poste".
* **Contesto:** Testo per video giornalistico TG aziendale.

**REQUISITI DI LUNGHEZZA:**
1. **WhatsApp:** ~90 caratteri.
2. **YouTube Titolo:** Max 49 caratteri.
3. **Social (FB/Linkedin):** Sintetico ma completo. Hashtag pertinenti.

**FORMATO OUTPUT (CSV PURO):**
L'output deve essere SOLO un blocco CSV.
* Delimitatore: Virgola (,)
* Qualificatore: Doppie virgolette (")
* Intestazione: ,${columnHeaders.join(',')}
* Righe richieste:
"Testo descrittivo news Canale WA",...
"Titolo YouTube",...
"Copy post e descrizione YT",...
"Link YouTube",...
"Link TG Poste",...

Genera solo il codice CSV.`;

            document.getElementById('promptCodeBlock').textContent = finalPrompt;
            document.getElementById('promptOutputArea').style.display = 'block';
        });

        copyBtn.addEventListener('click', () => {
            const txt = document.getElementById('promptCodeBlock').textContent;
            navigator.clipboard.writeText(txt).then(() => {
                const orig = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copiato';
                setTimeout(() => copyBtn.innerHTML = orig, 2000);
            });
        });
    }

    function openPromptModal() {
        // Pre-popola la modale con i testi inseriti nell'editor AI (se presenti)
        for(let i=0; i<3; i++) {
            const editorText = document.getElementById(`ai-input-${i}`).value;
            if(editorText) {
                document.getElementById(`modal-news-${i+1}`).value = editorText;
            }
        }
        document.getElementById('promptModal').classList.add('open');
    }

    /* --- LOGICHE ANTEPRIMA & CONTEGGI --- */
    function updatePreview(idx) {
      const getVal = (type) => document.getElementById(`${type}-${idx}`)?.value || '';
      
      // WA
      const waText = getVal('wa');
      const ytLink = getVal('ytLink');
      
      let waHtml = `${waText.replace(/\n/g, '<br>')}<br>${ytLink}<br>➡️ TG https://tgposte.poste.it/tgposte/`;
      const ytMatch = ytLink.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
      if (ytMatch && ytMatch[1]) {
          waHtml += `<br><img src="https://img.youtube.com/vi/${ytMatch[1]}/mqdefault.jpg" style="width:100%; border-radius:8px; margin-top:10px; border:1px solid #ddd;">`;
      }
      document.getElementById(`preview-wa-${idx}`).innerHTML = waHtml;

      // Social
      let ytDesc = getVal('ytDesc').trim();
      const tgLink = getVal('tgLink');
      let hashtags = '';
      const hashtagRegex = /(\s*#[^\s]*[^.\s])+$/;
      const match = ytDesc.match(hashtagRegex);
      if (match) {
        hashtags = match[0].trim();
        ytDesc = ytDesc.replace(hashtagRegex, '').trim();
      }
      const baseTags = "#TGPoste #PosteItaliane";
      const finalTags = hashtags ? `${baseTags} ${hashtags}` : baseTags;
      document.getElementById(`preview-social-${idx}`).innerText = `${ytDesc}\n\n➡️ ${tgLink}\n\n${finalTags}`;
    }

    function updateAllPreviews() {
      [0,1,2].forEach(i => {
         updateCounts(document.getElementById(`wa-${i}`));
         updateCounts(document.getElementById(`ytTitle-${i}`));
         updateCounts(document.getElementById(`ytDesc-${i}`));
         updatePreview(i);
      });
    }

    function updateCounts(el) {
      if(!el) return;
      const idParts = el.id.split('-'); 
      const type = idParts[0];
      const idx = idParts[1];
      const counter = document.getElementById(`count-${type}-${idx}`);
      if(counter && tabsConfig[0].limits[type]) {
        const len = el.value.length;
        const max = tabsConfig[0].limits[type];
        counter.innerText = `${len}/${max}`;
        counter.style.color = len > max ? 'red' : '#777';
      }
    }

    function handleTextAction(textarea, action, btnElement) {
      if(!textarea) return;
      if(action !== 'revert') textarea.dataset.original = textarea.value;
      
      let val = textarea.value;
      if(action === 'lower') val = val.toLowerCase();
      if(action === 'upper') val = val.toUpperCase();
      if(action === 'title') val = val.toLowerCase().replace(/(^|\s)\S/g, l => l.toUpperCase());
      if(action === 'revert') val = textarea.dataset.original || val;
      if(action === 'auto') { applyAutoFormat(textarea); }
      else {
          textarea.value = val;
          textarea.dispatchEvent(new Event('input'));
      }

      // Feedback visivo sul bottone
      if(btnElement) {
          const originalHTML = btnElement.innerHTML;
          btnElement.classList.add('success-feedback');
          btnElement.innerHTML = '<i class="fas fa-check"></i>';
          setTimeout(() => {
              btnElement.innerHTML = originalHTML;
              btnElement.classList.remove('success-feedback');
          }, 1000);
      }
    }

    function applyAutoFormat(textarea) {
      let text = textarea.value;
      const urls = [];
      text = text.replace(/(https?:\/\/[^\s]+)/g, (m) => { urls.push(m); return '___URL___'; });
      text = text.toLowerCase();
      text = text.replace(/(^|[.?!]\s+)([a-z])/g, (m, p1, p2) => p1 + p2.toUpperCase());
      masterList.forEach(word => {
        const re = new RegExp(`\\b${word}\\b`, 'gi');
        text = text.replace(re, word);
      });
      urls.forEach(u => { text = text.replace('___URL___', u); });
      textarea.value = text;
      textarea.dispatchEvent(new Event('input'));
    }

    /* --- IMPORT / EXPORT LOGIC --- */
    async function handleFileInput(event) {
        const file = event.target.files[0];
        if (!file) return;
        const fileName = file.name.toLowerCase();
        
        if (fileName.endsWith('.xlsx')) {
            await importFromExcel(file);
        } else if (fileName.endsWith('.csv')) {
            const reader = new FileReader();
            reader.onload = e => importFromCsvText(e.target.result);
            reader.readAsText(file);
        } else {
            alert('Formato non supportato. Usa .xlsx o .csv');
        }
        event.target.value = '';
    }

    async function handlePasteCsv() {
        try {
            const text = await navigator.clipboard.readText();
            if (text) {
                importFromCsvText(text);
            } else {
                alert('Appunti vuoti o permessi negati.');
            }
        } catch (error) {
            alert("Errore lettura appunti: " + error);
        }
    }

    async function importFromExcel(file) {
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        processImportRows(rows);
      } catch (e) {
        alert("Errore Import Excel: " + e.message);
      }
    }

    function importFromCsvText(csvText) {
        const rows = parseCsvText(csvText);
        if (rows.length > 0) processImportRows(rows);
        else alert("CSV vuoto o non valido");
    }

    function parseCsvText(csvText) {
        const rows = [];
        let row = [];
        let field = "";
        let inQuote = false;
        
        for (let i = 0; i < csvText.length; i++) {
            const c = csvText[i];
            if (inQuote) {
                if (c === '"') {
                    if (i + 1 < csvText.length && csvText[i + 1] === '"') {
                        field += '"'; i++;
                    } else { inQuote = false; }
                } else { field += c; }
            } else {
                if (c === '"') { inQuote = true; }
                else if (c === ',') { row.push(field); field = ""; }
                else if (c === '\n' || c === '\r') {
                    row.push(field); 
                    if (row.length > 0 && (row.length > 1 || row[0] !== "")) rows.push(row);
                    row = []; field = "";
                    if (c === '\r' && csvText[i + 1] === '\n') i++;
                } else { field += c; }
            }
        }
        if (field || row.length > 0) { row.push(field); rows.push(row); }
        return rows;
    }

    function processImportRows(rows) {
        if (!rows || rows.length < 2) return alert("Nessun dato valido trovato.");

        const fieldMap = {
            'Testo descrittivo news Canale WA': 'wa',
            'Titolo YouTube': 'ytTitle',
            'Copy post e descrizione YT': 'ytDesc',
            'Link YouTube': 'ytLink',
            'Link TG Poste': 'tgLink'
        };

        rows.slice(1).forEach(row => {
            const rowLabel = (row[0] || '').trim();
            const fieldType = fieldMap[rowLabel];
            
            if (fieldType) {
                for (let i = 0; i < 3; i++) {
                    const val = row[i + 1];
                    if (val !== undefined) {
                        const el = document.getElementById(`${fieldType}-${i}`);
                        if (el) {
                            el.value = String(val).replace(/""/g, '"');
                            el.dispatchEvent(new Event('input')); 
                        }
                    }
                }
            }
        });
        alert("Importazione completata!");
    }

    /* --- ALTRE UTILITY --- */
    
    async function handleAI(idx) {
      const input = document.getElementById(`ai-input-${idx}`).value;
      if(!input) return alert("Inserisci testo!");
      const loader = document.getElementById(`ai-loader-${idx}`);
      loader.style.display = 'block';
      try {
        const res = await fetch(API_URL, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({inputText: input})
        });
        const data = await res.json();
        const setVal = (id, val) => {
           const el = document.getElementById(id);
           el.value = val;
           el.dataset.original = val;
           el.dispatchEvent(new Event('input'));
        };
        setVal(`wa-${idx}`, data.whatsapp);
        setVal(`ytTitle-${idx}`, data.youtube);
        setVal(`ytDesc-${idx}`, data.facebook_linkedin);
      } catch(e) { alert("Errore AI: " + e.message); } finally { loader.style.display = 'none'; }
    }

    function copyToClipboard(text, btn) {
      navigator.clipboard.writeText(text).then(() => {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => btn.innerHTML = originalHTML, 1500);
      });
    }

    function saveData(idx, btn) {
      const data = {};
      document.querySelectorAll(`.tab-pane[data-tab="${idx}"] textarea`).forEach(el => {
        data[el.dataset.type] = el.value;
      });
      localStorage.setItem(`news_data_${idx}`, JSON.stringify(data));
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i> Salvato';
      setTimeout(() => btn.innerHTML = originalHTML, 1500);
    }

    function loadSavedData() {
      [0,1,2].forEach(idx => {
        const saved = localStorage.getItem(`news_data_${idx}`);
        if(saved) {
          const data = JSON.parse(saved);
          Object.keys(data).forEach(key => {
            const el = document.getElementById(`${key}-${idx}`);
            if(el) {
                el.value = data[key];
                el.dispatchEvent(new Event('input'));
            }
          });
        }
      });
    }

    function clearData(idx) {
      if(!confirm("Cancelli tutto?")) return;
      document.querySelectorAll(`.tab-pane[data-tab="${idx}"] textarea`).forEach(el => {
        el.value = '';
        el.dispatchEvent(new Event('input'));
      });
    }

    function generateTgLink(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const d_raw = String(date.getDate());
        const months = ['gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno', 'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'];
        return `https://tgposte.poste.it/tgposte/${y}/${m}/${d}/tg-poste-del-${d_raw}-${months[date.getMonth()]}-${y}/`;
    }

    async function getMasterList() {
      try {
        const r = await fetch(googleSheetURL);
        const t = await r.text();
        return t.split('\n').map(s => s.trim()).filter(Boolean);
      } catch { return []; }
    }
    
    function copyAllData() {
       let txt = '';
       [0,1,2].forEach(i => {
          txt += `NEWS ${i+1}\nWA: ${document.getElementById(`wa-${i}`).value}\nYT Title: ${document.getElementById(`ytTitle-${i}`).value}\nSocial: ${document.getElementById(`ytDesc-${i}`).value}\n\n`;
       });
       navigator.clipboard.writeText(txt).then(() => alert("Copiato tutto!"));
    }

    function exportExcel() {
       const rows = [["News", "WA", "YT Title", "YT Desc", "YT Link", "TG Link"]];
       [0,1,2].forEach(i => {
         rows.push([
           `News ${i+1}`,
           document.getElementById(`wa-${i}`).value,
           document.getElementById(`ytTitle-${i}`).value,
           document.getElementById(`ytDesc-${i}`).value,
           document.getElementById(`ytLink-${i}`).value,
           document.getElementById(`tgLink-${i}`).value
         ]);
       });
       const wb = XLSX.utils.book_new();
       XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "Export");
       XLSX.writeFile(wb, "export_social.xlsx");
    }

    function exportCsv() {
        const rows = [["News", "WA", "YT Title", "YT Desc", "YT Link", "TG Link"]];
       [0,1,2].forEach(i => {
         rows.push([
           `News ${i+1}`,
           `"${document.getElementById(`wa-${i}`).value.replace(/"/g, '""')}"`,
           `"${document.getElementById(`ytTitle-${i}`).value.replace(/"/g, '""')}"`,
           `"${document.getElementById(`ytDesc-${i}`).value.replace(/"/g, '""')}"`,
           `"${document.getElementById(`ytLink-${i}`).value.replace(/"/g, '""')}"`,
           `"${document.getElementById(`tgLink-${i}`).value.replace(/"/g, '""')}"`
         ]);
       });
       const csvContent = rows.map(e => e.join(",")).join("\n");
       const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
       const link = document.createElement("a");
       const url = URL.createObjectURL(blob);
       link.setAttribute("href", url);
       link.setAttribute("download", "export.csv");
       document.body.appendChild(link);
       link.click();
       document.body.removeChild(link);
    }

    // Avvio
    document.addEventListener('DOMContentLoaded', init);

  </script>
</body>
</html>
